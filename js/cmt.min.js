! function () {

    function h(sel) {
        this._cmtwrapper = template('<div id="hualong-main"><div class="hl-cmt-header"><div id="header-avatar-s" class="header-avatar-s header-avatar-unlogin"><img id="cmt-header-avatar" src="http://cmt.cqnews.net/template/images/default_head.png"/></div><div class="header-username-s" id="cmt-header-username">未登录</div><div class="header-content-s"><div class="header-content-w"><div class="header-content-textareabox"><textarea id="content-textarea" class="content-textarea" placeholder="说两句吧..."></textarea></div><ul class="header-content-img"></ul></div><div class="header-content-info"><div class="header-content-face" style="display:none"><img src="http://cmt.cqnews.net/template/images/face.png"/></div><div class="header-content-upimg"><img src="http://cmt.cqnews.net/template/images/image.png"/><form method="post" id="content-upimg-form" enctype="multipart/form-data"><input id="content-upimg-input" type="file" accept="image/*"/></form></div><div id="header-content-cmtbtn" class="header-content-cmtbtn">发表评论</div></div></div></div><%if (itemList.length !==0){%><div class="hl-cmt-title"><span>评论</span><div class="cmt-number-count"><i class="hl-cmt-totalcount">0</i>条评论</div></div><div class="hl-cmt-list"><%:=tplItem({itemList:itemList})%></div><%}else{%><div class="hl-cmt-empty">还没有评论，快去评论一条吧</div><%}%></div>'),
            this._cmtimage = template('<li class="content-img-pic"><img id="content-img-pic" src="<%=imageurl%>"/><span class="content-img-delete"><i id="content-img-delete">X</i></span></li>'),
            this._cmtreplyimage = template('<li class="reply-img-pic"><img id="reply-img-pic" src="<%=imageurl%>"/><span class="reply-img-delete"><i id="reply-img-delete">X</i></span></li>'),
            this._cmtitem = template('<%for(var i=0;i<itemList.length;i++){%><div class="cmt-item-li" data-id="<%=itemList[i].id%>"><div class="cmt-item-avatar"><%if (itemList[i].replyUserUrl !== null && itemList[i].replyUserUrl !== ""){%><img src="<%=itemList[i].replyUserUrl%>"/><%}%></div><div class="cmt-item-info"><div class="cmt-item-cmttime"><%=itemList[i].createTime%></div><span class="cmt-item-username"><%=itemList[i].replyUserName%></span></div><div class="cmt-item-word"><%:=itemList[i].content%></div><%if (itemList[i].imageUrl){%><ul class="cmt-item-img"><li><img src="<%=itemList[i].imageUrl%>"/></li></ul><%}%><%if (itemList[i].passiveReplyId){%><div class="cmt-item-reply"><div class="reply-block"><div class="reply-block-word"><b class="reply-block-reply">回复</b><span class="reply-block-user"><%=itemList[i].passiveReplyName%></span>：<%:=itemList[i].sourceTitle%></div><%if (itemList[i].passiveReplyImageUrl){%><ul class="cmt-item-img"><li><img src="<%=itemList[i].passiveReplyImageUrl%>"/></li></ul><%}%></div></div><%}%><div class="cmt-item-operate"><span class="item-btn-support"><%=itemList[i].praise%></span><span class="item-btn-reply">回复</span></div></div><%}%><%if(itemList.length>=10){%><div id="cmt-item-linksmore" class="cmt-item-linksmore">查看更多</div><%}%>'),
            this._cmtreply = template('<div class="reply-content-s"><div class="reply-content-w"><div class="reply-content-textareabox"><textarea id="reply-textarea" class="reply-textarea" placeholder="说两句吧..."></textarea></div><ul class="reply-content-img"></ul></div><div class="reply-content-info"><div class="reply-content-upimg"><img src="http://cmt.cqnews.net/template/images/image.png"/><form method="post" id="reply-upimg-form" enctype="multipart/form-data"><input id="reply-upimg-input" type="file" accept="image/*"/></form></div><div id="reply-content-cmtbtn" class="reply-content-cmtbtn">发表评论</div></div></div>'),
            this._cmtlogin = template('<div class="hl-cmt-login"><div class="cmt-login-box"><span class="cmt-login-state">手机登录</span><span class="cmt-login-text">华龙网</span><div class="cmt-login-phone"><input id="login-input-phone" type="number" placeholder="手机号"/></div><div class="cmt-login-phone"><input id="login-input-password" type="password" placeholder="密码"/></div><span class="cmt-login-sure">我已阅读并同意<a href="http://news.cqnews.net/html/2017-09/20/content_42944090.htm" target="_blank">用户管理条例</a></span><div class="cmt-login-phone"><div id="btn-hl-login" class="cmt-btn-login">登录</div></div><div class="cmt-login-forget"><span id="btn-hl-forget" class="cmt-btn-forget">忘记密码</span></div><div class="cmt-login-phone"><div id="btn-hl-register" class="cmt-btn-register">注册</div></div></div></div>'),
            this._cmtreigster = template('<div class="hl-cmt-login"><div class="cmt-login-box"><span class="cmt-login-state">手机注册</span><span class="cmt-login-text">华龙网</span><div class="cmt-login-phone"><input id="login-input-phone" type="number" placeholder="手机号"/></div><div class="cmt-login-phone"><div class="cmt-login-verification"><input id="login-input-capt" type="number" placeholder="验证码"/><div class="cmt-btn-verification" data-id="0">发送验证码</div></div></div><div class="cmt-login-phone"><input id="login-input-password" type="password" placeholder="密码"/></div><span class="cmt-login-sure">我已阅读并同意<a href="http://news.cqnews.net/html/2017-09/20/content_42944090.htm" target="_blank">用户管理条例</a></span><div class="cmt-login-phone"><div id="btn-hl-upregister" class="cmt-btn-login">提交注册</div></div></div></div>'),
            this._cmtreset = template('<div class="hl-cmt-login"><div class="cmt-login-box"><span class="cmt-login-state">找回密码</span><span class="cmt-login-text">华龙网</span><div class="cmt-login-phone"><input id="login-input-phone" type="number" placeholder="手机号"/></div><div class="cmt-login-phone"><div class="cmt-login-verification"><input id="login-input-capt" type="number" placeholder="验证码"/><div class="cmt-btn-verification" data-id="2">发送验证码</div></div></div><div class="cmt-login-phone"><input id="login-input-password" type="password" placeholder="新密码"/></div><span class="cmt-login-sure">我已阅读并同意<a href="http://news.cqnews.net/html/2017-09/20/content_42944090.htm" target="_blank">用户管理条例</a></span><div class="cmt-login-phone"><div id="login-input-findpsw" class="cmt-btn-login">修改密码</div></div></div></div>'),
            this._cmtlayer = template('<div class="hl-cmt-layer" <%if(tips.length>10){%>style="width:210px"<%}%> ><%=tips%></div>'),
            this._base_URL = "http://cmt.cqnews.net",
            this.sid = $(sel).attr('sid'),
            this.stype = $(sel).attr('stype') || 40,
            this._hualongMain = $(sel)
    }

    //初始化
    h.prototype.initCmt = function () {
        var self = this;
        this.getList(this.sid, function (e) {
            self.cmtCliks();
            $('.hl-cmt-totalcount').text(e);

            //埋点统计
            var contentID = document.location.href.match(/content_\d{6,16}\.htm[l]?/);
            if (contentID != null) {
                if (window.spm) {
                    spm.config({
                        siteId: 'zm5129-001', // 此处填写该网站对应的网站标识（即SPM a段） 例如'zmXXXX-001'
                        additionalInfo: {
                            targetID: contentID[0].replace(/content_|\.htm[l]?/ig, ''), // 此处填写稿件ID
                            organization: 'zm5129', // 此处填写机构ID
                            // 上报进入事件
                            category: 'event',
                            action: 'comeIn'
                        }
                    });
                }
            }
        });
    }
    h.prototype.getList = function (sid, callback) {
        var self = this;
        $.ajax({
            type: "post",
            url: self._base_URL + "/comment/reply/" + sid + "/list",
            data: {
                sourceType: self.stype
            },
            xhrFields: {
                withCredentials: true
            },
            success: function (res) {
                if (res.code >= 0) {
                    var html = self._cmtwrapper({
                        tplItem: self._cmtitem,
                        itemList: res.data.dataList
                    });
                    self._hualongMain.html(html);
                    callback(res.totalCount);
                } else {
                    self._hualongMain.html(self._cmtwrapper({
                        itemList: ""
                    }));
                    self.layermsg(res.message);
                    callback(0)
                }
                self.checkCookie();
            }
        });
    }
    h.prototype.getMore = function (sid, lid, callback) {
        var self = this;
        $.ajax({
            type: "post",
            url: self._base_URL + "/comment/reply/" + sid + "/list",
            xhrFields: {
                withCredentials: true
            },
            data: {
                lastId: lid,
                sourceType: self.stype
            },
            success: function (res) {
                if (res.code >= 0) {
                    $('.hl-cmt-list').append(self._cmtitem({
                        itemList: res.data.dataList
                    }));
                } else {
                    self.layermsg(res.message);
                }
            }
        });
    }
    h.prototype.getCaptcha = function (p, t) {
        var self = this;
        $.ajax({
            type: "post",
            url: self._base_URL + "/cms/user/getCaptcha",
            xhrFields: {
                withCredentials: true
            },
            data: {
                phone: p,
                type: t //0注册 2找回密码
            },
            success: function (res) {
                self.layermsg(res.message || "已发送");
            }
        });
    }
    h.prototype.register = function (l, p, c, callback) {
        var self = this;
        $.ajax({
            type: "post",
            url: self._base_URL + "/cms/user/register",
            xhrFields: {
                withCredentials: true
            },
            data: {
                loginName: l,
                pwd: p,
                captcha: c
            },
            success: function (res) {
                if (res.code >= 0) {
                    callback(res);
                } else {
                    self.layermsg(res.message);
                }
            }
        });
    }
    h.prototype.getlogin = function (l, p, callback) {
        var self = this;
        $.ajax({
            type: "post",
            url: self._base_URL + "/cms/user/login",
            xhrFields: {
                withCredentials: true
            },
            data: {
                loginName: l,
                pwd: p
            },
            success: function (res) {
                if (res.code >= 0) {
                    callback(res);
                } else {
                    self.layermsg(res.message);
                }
            }
        });
    }
    h.prototype.findPwd = function (l, p, c, callback) {
        var self = this;
        $.ajax({
            type: "post",
            url: self._base_URL + "/cms/user/findPwd",
            xhrFields: {
                withCredentials: true
            },
            data: {
                phone: l,
                pwd: p,
                captcha: c
            },
            success: function (res) {
                if (res.code >= 0) {
                    callback(res);
                } else {
                    self.layermsg(res.message);
                }
            }
        });
    }
    h.prototype.uploadcmt = function (that, callback) {
        var self = this;
        var that = that || $('#content-upimg-input')[0];
        var fd = new FormData();

        fd.append('pic', that.files[0]);
        $.ajax({
            type: "post",
            url: self._base_URL + "/cms/user/upload",
            xhrFields: {
                withCredentials: true
            },
            data: fd,
            contentType: false,
            processData: false,
            success: function (res) {
                if (res.code >= 0 && res.code !== 999992) {
                    callback(res);
                }
                res.code === 999992 && self.showcmt_login(self._cmtlogin);
            }
        });
    }
    h.prototype.setSave = function (sid, sjson, callback) {
        var self = this;
        $.ajax({
            type: "post",
            url: self._base_URL + "/comment/reply/" + sid + "/save",
            xhrFields: {
                withCredentials: true
            },
            data: sjson,
            success: function (res) {
                self.layermsg(res.message);
                if (res.code >= 0) {
                    callback(res);
                }
                res.code === 999992 && self.showcmt_login(self._cmtlogin);
            }
        });

        // 埋点统计
        if (window.spm) {
            spm.push({
                category: 'event',
                action: 'comment',
                comment: sjson.content,
                targetURL: window.location.href
            });
        }

    }
    h.prototype.setCookie = function (cname, cvalue, exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
        var expires = "expires=" + d.toGMTString() + "; path=/" + ";domain=.cqnews.net";
        document.cookie = cname + "=" + cvalue + "; " + expires;
    }
    h.prototype.getCookie = function (cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = $.trim(ca[i]);
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }
    h.prototype.checkCookie = function () {
        var nickName = this.getCookie("cmt_nickName");
        var imgUrl = this.getCookie("cmt_imgUrl");
        if (nickName != "" && imgUrl != "") {
            if (imgUrl !== "null") {
                $("#cmt-header-avatar").attr('src', imgUrl)
            };
            $("#cmt-header-username").text(nickName);
            $("#header-avatar-s").removeClass("header-avatar-unlogin").addClass("header-avatar-islogin");
        }
    }
    h.prototype.check_input = function (phone, psw, capt) {
        var reg = /^1[3456789][0-9]{9}$/;
        var phone = phone || "";
        var capt = capt || "";
        var psw = psw || "";
        if (phone == "") {
            this.layermsg("请输入手机号");
            return false;
        }
        if (!reg.test(phone)) {
            this.layermsg('请输入正确的手机号');
            return false;
        }
        if (psw == "") {
            this.layermsg('请输入密码');
            return false;
        }
        if (psw.length < 6) {
            this.layermsg('密码最少6位');
            return false;
        }
        if (capt !== "n") {
            if (capt == "") {
                this.layermsg('请输入验证码');
                return false;
            }
        }
        return true;
    }
    h.prototype.layermsg = function (text) {
        var text = text || "";
        $('#hualong-main').append(this._cmtlayer({
            tips: text
        }));
        $('.hl-cmt-layer').animate({
            'opacity': 1
        }, 500, function () {
            var self = $(this);
            setTimeout(function () {
                self.remove();
            }, 1000);
        });
    }
    h.prototype.showcmt_login = function (_cmtw) {
        $('#hualong-main').append(_cmtw);
    }
    h.prototype.hidecmt_login = function () {
        $('.hl-cmt-login').remove();
    }
    h.prototype.showcmt_reply = function (that) {
        var that = that || '';
        $(that).parents('.cmt-item-li').append(this._cmtreply);
    }
    h.prototype.hidecmt_reply = function () {
        $('.reply-content-s').remove();
    }
    h.prototype.removecmt_upimg = function () {
        var obj = document.getElementById('content-upimg-input');
        obj.outerHTML = obj.outerHTML;
    }
    h.prototype.addcmt_upimg = function (imgurl, i) {
        var imgurl = imgurl || "";
        if (i === true) {
            $('.header-content-img').append(this._cmtimage({
                imageurl: imgurl
            }));
        } else {
            $('.reply-content-img').append(this._cmtreplyimage({
                imageurl: imgurl
            }));
        }
    }
    h.prototype.deletecmt_upimg = function () {
        $('.header-content-img').empty();
    }
    h.prototype.cmtCliks = function () {
        var _hualongMain = this._hualongMain;
        var self = this;
        _hualongMain.on('click', '.header-avatar-unlogin', function (e) {
                self.showcmt_login(self._cmtlogin);
            }),
            _hualongMain.on('click', '.header-avatar-islogin', function (e) {
                self.layermsg('已登录');
            }),
            _hualongMain.on('click', '.hl-cmt-login', function (e) {
                self.hidecmt_login();
            }),
            _hualongMain.on('click', '.cmt-login-box', function (e) {
                e.stopPropagation();
            }),
            _hualongMain.on('click', '#btn-hl-forget', function (e) {
                self.hidecmt_login();
                self.showcmt_login(self._cmtreset);
            }),
            _hualongMain.on('click', '#btn-hl-register', function (e) {
                self.hidecmt_login();
                self.showcmt_login(self._cmtreigster);
            }),
            _hualongMain.on('click', '.item-btn-reply', function (e) {
                if (!$(this).hasClass('btn-reply-visited')) {
                    $('.item-btn-reply').removeClass('btn-reply-visited').text('回复');
                    self.hidecmt_reply();
                    self.showcmt_reply(this);
                    $(this).addClass('btn-reply-visited').text('收起');
                } else {
                    $(this).removeClass('btn-reply-visited').text('回复');
                    self.hidecmt_reply();
                }
            }),
            _hualongMain.on('click', '.item-btn-support', function (e) {
                var support = this;
                var p = $(support).parents('.cmt-item-li');
                var supportId = p.attr('data-id');

                $.ajax({
                    type: "post",
                    url: self._base_URL + "/comment/reply/" + supportId + "/doPraise",
                    xhrFields: {
                        withCredentials: true
                    },
                    data: {
                        "sourceType": self.stype
                    },
                    success: function (res) {
                        self.layermsg(res.message || '点赞成功');
                        if (res.code >= 0 && res.code !== 999992) {
                            var text = parseInt($(support).text()) + 1;
                            $(support).removeClass('item-btn-support').addClass('btn-support-visited').text(text);
                        }
                        res.code === 999992 && self.showcmt_login(self._cmtlogin);
                    }
                });
            }),
            _hualongMain.on('click', '#btn-hl-login', function (e) {
                var phone = $("#login-input-phone").val();
                var psw = $("#login-input-password").val();
                if (self.check_input(phone, psw, "n")) {
                    self.getlogin(phone, psw, function (e) {
                        $("#cmt-header-username").text(e.data.nickName);
                        self.setCookie("cmt_nickName", e.data.nickName);
                        self.setCookie("cmt_imgUrl", e.data.imgUrl);
                        self.checkCookie();
                        self.hidecmt_login();
                    });
                }
            }),
            _hualongMain.on('click', '#btn-hl-upregister', function (e) {
                var phone = $("#login-input-phone").val();
                var capt = $("#login-input-capt").val();
                var psw = $("#login-input-password").val();
                if (self.check_input(phone, psw, capt)) {
                    self.register(phone, psw, capt, function (e) {
                        self.layermsg(e.message || "注册成功，请登录");
                        self.hidecmt_login();
                        self.showcmt_login(self._cmtlogin);
                    });
                }
            }),
            _hualongMain.on('click', '.cmt-btn-verification', function (e) {
                var reg = /^1[3456789][0-9]{9}$/;
                var p = $("#login-input-phone").val();
                var t = $(this).attr("data-id");
                if (p == "") {
                    self.layermsg('请输入手机号');
                    return false;
                }
                if (!reg.test(p)) {
                    self.layermsg('请输入正确的手机号');
                    return false;
                }
                if (!$(this).hasClass('verificationing')) {
                    self.getCaptcha(p, t);
                    $(this).addClass('verificationing');
                    var ctime = 60;
                    var ctimer = setInterval(function () {
                        if ($('.cmt-btn-verification').hasClass('verificationing')) {
                            $('.cmt-btn-verification').text(--ctime + "s后重新发送");
                            if (ctime === 0) {
                                $('.cmt-btn-verification').removeClass('verificationing').text("重新发送验证码");
                                clearInterval(ctimer);
                            }
                        } else {
                            clearInterval(ctimer);
                        }
                    }, 1000);
                }
            }),
            _hualongMain.on('click', '#login-input-findpsw', function (e) {
                var phone = $("#login-input-phone").val();
                var capt = $("#login-input-capt").val();
                var psw = $("#login-input-password").val();
                if (self.check_input(phone, psw, capt)) {
                    self.findPwd(phone, psw, capt, function (e) {
                        self.layermsg(e.message || "修改成功，请登录");
                        self.hidecmt_login();
                        self.showcmt_login(self._cmtlogin);
                    });
                }
            }),
            _hualongMain.on('click', '#header-content-cmtbtn', function (e) {
                var sid = self.sid;
                var content = $("#content-textarea").val();
                var imageUrl = $("#content-img-pic").attr('src') || "";
                var stitle = $('title').text();
                if ($.trim(content) == "") {
                    self.layermsg('评论内容为空');
                    return false;
                }
                self.setSave(sid, {
                    "content": content,
                    "imageUrl": imageUrl,
                    "sourceTitle": stitle,
                    "sourceType": self.stype
                }, function (res) {
                    self.deletecmt_upimg();
                    $("#content-textarea").val("");
                });
            }),
            _hualongMain.on('change', '#content-upimg-input', function (e) {
                self.uploadcmt(this, function (e) {
                    self.deletecmt_upimg();
                    self.removecmt_upimg();
                    self.addcmt_upimg(e.data.url, true);
                });
            }),
            _hualongMain.on('change', '#reply-upimg-input', function (e) {
                self.uploadcmt(this, function (e) {
                    $('.reply-content-img').empty();
                    var obj = document.getElementById('reply-upimg-input');
                    obj.outerHTML = obj.outerHTML;
                    self.addcmt_upimg(e.data.url, false);
                });
            }),
            _hualongMain.on('click', '#content-img-delete', function (e) {
                self.deletecmt_upimg();
            }),
            _hualongMain.on('click', '#reply-img-delete', function (e) {
                $('.reply-content-img').empty();
            }),
            _hualongMain.on('click', '#cmt-item-linksmore', function (e) {
                $(this).remove();
                var lid = $('.cmt-item-li').last().attr('data-id');
                self.getMore(self.sid, lid);
            }),
            _hualongMain.on('click', '#reply-content-cmtbtn', function () {
                var p = $(this).parents('.cmt-item-li');
                var stitle = p.find('.cmt-item-word').text();
                var replyId = p.attr('data-id');
                var imageUrl = $('#reply-img-pic').attr('src') || "";
                var content = $('#reply-textarea').val();
                if ($.trim(content) == "") {
                    self.layermsg('评论内容为空');
                    return false;
                }
                self.setSave(self.sid, {
                    "content": content,
                    "imageUrl": imageUrl,
                    "sourceTitle": stitle,
                    "replyId": replyId,
                    "sourceType": self.stype
                }, function (res) {
                    $('.reply-content-img').empty();;
                    $("#reply-textarea").val("");
                });
            })
    }

    var a = new h('#hualong');
    a.initCmt()

}()